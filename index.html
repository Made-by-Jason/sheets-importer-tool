<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spreadsheet Data Import Tool — Enhanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --google-blue: #4285f4;
      --google-red: #ea4335;
      --google-yellow: #fbbc05;
      --google-green: #34a853;
    }
    html, body { height: 100%; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .app-bg {
      background: radial-gradient(1200px 600px at 10% -10%, rgba(66,133,244,0.18), transparent 60%),
                  radial-gradient(1000px 500px at 110% 10%, rgba(52,168,83,0.18), transparent 60%),
                  linear-gradient(180deg, #0f172a 0%, #0b1220 100%);
    }
    .card { transition: transform .25s, box-shadow .25s; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,.15); }
    .progress-stripes {
      background-image: linear-gradient(45deg, rgba(255,255,255,.25) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.25) 50%, rgba(255,255,255,.25) 75%, transparent 75%, transparent);
      background-size: 1rem 1rem;
      animation: move 1s linear infinite;
    }
    @keyframes move { to { background-position: 1rem 0; } }
    input[type="file"] { display:none; }
    .scroll-shadow {
      mask-image: linear-gradient(to bottom, transparent, black 20px, black calc(100% - 20px), transparent);
      -webkit-mask-image: linear-gradient(to bottom, transparent, black 20px, black calc(100% - 20px), transparent);
    }
    .badge-demo { background: linear-gradient(90deg, #fbbc05, #ea4335); }
    .toggle { position: relative; width: 42px; height: 24px; }
    .toggle input { opacity:0; width:0; height:0; }
    .knob {
      position:absolute; top:2px; left:2px; width:20px; height:20px; border-radius:9999px;
      transition: transform .2s ease; background:white;
      box-shadow: 0 2px 6px rgba(0,0,0,.25);
    }
    .track { position:absolute; inset:0; border-radius:9999px; transition: background .2s ease; }
    .toggle input:checked ~ .knob { transform: translateX(18px); }
  </style>
</head>
<body class="app-bg text-slate-100">
  <header class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg flex items-center justify-center"
             style="background: conic-gradient(from 180deg, var(--google-blue), var(--google-green), var(--google-yellow), var(--google-red), var(--google-blue));">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="white" aria-hidden="true">
            <path d="M3 4h18v4H3zM3 10h18v4H3zM3 16h18v4H3z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl font-semibold tracking-tight">Spreadsheet Data Import Tool</h1>
          <p class="text-slate-300 text-sm">Upload, transform, map, validate, schedule, and track</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="badge-demo text-xs font-semibold text-white px-2 py-1 rounded">Demo</span>
        <button id="publishInfo" class="text-slate-300 hover:text-white text-sm underline decoration-dotted">About connections</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-10 grid grid-cols-1 lg:grid-cols-12 gap-6">
    <aside class="lg:col-span-3">
      <div class="card bg-slate-900/40 backdrop-blur border border-slate-800 rounded-2xl p-4">
        <nav class="space-y-1" id="sidebarMenu">
          <button data-section="dashboard" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-800" aria-selected="true">
            <span class="w-2 h-2 rounded-full bg-sky-500"></span>
            <span class="text-sm font-medium">Dashboard</span>
          </button>
          <button data-section="library" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-800">
            <span class="w-2 h-2 rounded-full bg-indigo-400"></span>
            <span class="text-sm font-medium">Library</span>
          </button>
          <button data-section="imports" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-800">
            <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
            <span class="text-sm font-medium">New Import</span>
          </button>
          <button data-section="schedules" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-800">
            <span class="w-2 h-2 rounded-full bg-amber-400"></span>
            <span class="text-sm font-medium">Schedules</span>
          </button>
          <button data-section="history" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-800">
            <span class="w-2 h-2 rounded-full bg-fuchsia-400"></span>
            <span class="text-sm font-medium">History</span>
          </button>
          <button data-section="settings" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-800">
            <span class="w-2 h-2 rounded-full bg-slate-400"></span>
            <span class="text-sm font-medium">Settings</span>
          </button>
          <button data-section="connections" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-800">
            <span class="w-2 h-2 rounded-full bg-emerald-300"></span>
            <span class="text-sm font-medium">Connections</span>
          </button>
        </nav>

        <div class="mt-6 p-3 rounded-xl bg-slate-900/60 border border-slate-800">
          <div class="text-xs text-slate-300 leading-5">
            Tip: Auto-map gets smarter when you add aliases in Settings.
          </div>
        </div>
      </div>
    </aside>

    <section class="lg:col-span-9 space-y-6">
      <!-- Dashboard -->
      <div id="section-dashboard" class="card bg-white/5 rounded-2xl p-6 border border-white/10">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
          <div>
            <h2 class="text-lg font-semibold">Overview</h2>
            <p class="text-slate-300 text-sm">Quick stats from your recent imports</p>
          </div>
          <button id="startImportFromDashboard" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-sky-600 hover:bg-sky-500 text-white">
            <span>+ New Import</span>
          </button>
        </div>

        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
          <div class="rounded-xl bg-slate-900/40 p-4 border border-slate-800">
            <div class="text-slate-300 text-sm">Total Imports</div>
            <div id="stat-total-imports" class="text-2xl font-semibold mt-1">0</div>
          </div>
          <div class="rounded-xl bg-slate-900/40 p-4 border border-slate-800">
            <div class="text-slate-300 text-sm">Rows Processed</div>
            <div id="stat-total-rows" class="text-2xl font-semibold mt-1">0</div>
          </div>
          <div class="rounded-xl bg-slate-900/40 p-4 border border-slate-800">
            <div class="text-slate-300 text-sm">Success Rate</div>
            <div id="stat-success-rate" class="text-2xl font-semibold mt-1">—</div>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="text-sm font-medium text-slate-300 mb-2">Recent Activity</h3>
          <div id="dashboardRecent" class="space-y-2"></div>
        </div>
      </div>

      <!-- Library -->
      <div id="section-library" class="card bg-white/5 rounded-2xl p-6 border border-white/10 hidden">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">Library</h2>
            <p class="text-slate-300 text-sm">Your spreadsheets in one place</p>
          </div>
          <div class="flex items-center gap-2">
            <input id="librarySearch" placeholder="Search titles" class="bg-slate-900 text-slate-100 text-sm rounded-lg px-3 py-2 border border-slate-800 w-56" />
            <button id="refreshLibrary" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-sm">Refresh</button>
          </div>
        </div>
        <div id="libraryEmpty" class="mt-6 text-sm text-slate-300 py-10 text-center hidden">No items yet. Click Refresh to load samples.</div>
        <div id="libraryGrid" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>

      <!-- Imports -->
      <div id="section-imports" class="card bg-white/5 rounded-2xl p-6 border border-white/10 hidden">
        <h2 class="text-lg font-semibold">Start a new import</h2>
        <p class="text-slate-300 text-sm mb-4">Choose a source and get your data ready</p>

        <div class="grid md:grid-cols-3 gap-4">
          <!-- CSV Upload -->
          <div class="rounded-xl bg-slate-900/40 p-4 border border-slate-800">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-sky-600">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M19 2H8c-1.1 0-2 .9-2 2v3H5c-1.1 0-2 .9-2 2v9c0 1.1.9 2 2 2h7l2-2h5c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12h-7l-2 2H5V9h2V4h12v10z"/></svg>
              </div>
              <div class="font-medium">Upload CSV</div>
            </div>
            <p class="text-slate-300 text-sm mt-2">Import from a local CSV file</p>
            <label for="csvFile" class="mt-3 inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-sky-600 hover:bg-sky-500 text-white cursor-pointer">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M5 20h14v-2H5v2zM12 2l-5.5 9h11z"/></svg>
              <span>Choose file</span>
            </label>
            <input id="csvFile" type="file" accept=".csv" />
            <button id="csvSample" class="mt-2 text-sky-400 text-sm hover:underline">Use sample CSV</button>
          </div>

          <!-- Paste Clipboard -->
          <div class="rounded-xl bg-slate-900/40 p-4 border border-slate-800">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-emerald-600">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v15a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2zm-7 0a1 1 0 011 1h-2a1 1 0 011-1zM5 20V5h14v15H5z"/></svg>
              </div>
              <div class="font-medium">Paste from clipboard</div>
            </div>
            <p class="text-slate-300 text-sm mt-2">Paste rows with commas or tabs</p>
            <button id="openPaste" class="mt-3 inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white">
              <span>Open paste box</span>
            </button>
          </div>

          <!-- Google Sheets -->
          <div class="rounded-xl bg-slate-900/40 p-4 border border-slate-800">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-amber-500">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M19 2H8c-1.1 0-2 .9-2 2v4h2V4h11v16H8v-4H6v4c0 1.1.9 2 2 2h11c1.11 0 2-.9 2-2V4c0-1.1-.89-2-2-2zM3 12l4 4V8l-4 4z"/></svg>
              </div>
              <div class="font-medium">Google Sheets</div>
              <span class="ml-auto text-xs px-2 py-0.5 rounded-full bg-white/10 border border-white/10">Placeholders ready</span>
            </div>
            <p class="text-slate-300 text-sm mt-2">Use a published CSV link or the Google Sheets API</p>
            <div class="mt-3 flex gap-2">
              <button id="openSheetsCSV" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold">
                Paste CSV link
              </button>
              <button id="openSheetsAPI" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold">
                Use API
              </button>
            </div>
          </div>
        </div>

        <!-- Steps -->
        <div id="pipeline" class="mt-6 hidden">
          <ol class="grid md:grid-cols-4 gap-4">
            <li class="rounded-xl p-4 border border-slate-800 bg-slate-900/40">
              <div class="text-sm font-semibold">1. Preview</div>
              <p class="text-slate-300 text-sm">Check your data sample</p>
            </li>
            <li class="rounded-xl p-4 border border-slate-800 bg-slate-900/40">
              <div class="text-sm font-semibold">2. Transform</div>
              <p class="text-slate-300 text-sm">Clean & shape your data</p>
            </li>
            <li class="rounded-xl p-4 border border-slate-800 bg-slate-900/40">
              <div class="text-sm font-semibold">3. Map Columns</div>
              <p class="text-slate-300 text-sm">Connect source to fields</p>
            </li>
            <li class="rounded-xl p-4 border border-slate-800 bg-slate-900/40">
              <div class="text-sm font-semibold">4. Validate & Run</div>
              <p class="text-slate-300 text-sm">Fix issues and import</p>
            </li>
          </ol>

          <!-- Preview -->
          <div class="mt-6 rounded-xl border border-slate-800 overflow-hidden">
            <div class="flex items-center justify-between bg-slate-900/60 px-4 py-3">
              <div class="text-sm font-medium">Data preview</div>
              <div class="flex items-center gap-3">
                <div class="flex items-center gap-2">
                  <label class="text-sm text-slate-300">Delimiter</label>
                  <select id="delimiter" class="bg-slate-800 text-slate-100 text-sm rounded-lg px-2 py-1 border border-slate-700">
                    <option value=",">Comma</option>
                    <option value=";">Semicolon</option>
                    <option value="tab">Tab</option>
                  </select>
                </div>
                <div class="flex items-center gap-2">
                  <label class="text-sm text-slate-300">Quick filter</label>
                  <input id="quickFilter" type="text" placeholder="Type to filter rows" class="bg-slate-800 text-slate-100 text-sm rounded-lg px-2 py-1 border border-slate-700 w-48">
                </div>
                <div class="flex items-center gap-2">
                  <label class="text-sm text-slate-300">Show</label>
                  <select id="rowLimit" class="bg-slate-800 text-slate-100 text-sm rounded-lg px-2 py-1 border border-slate-700">
                    <option>50</option><option>100</option><option>250</option><option>All</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="max-h-56 overflow-auto scroll-shadow bg-slate-900/30">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-900/40 sticky top-0">
                  <tr id="previewHead"></tr>
                </thead>
                <tbody id="previewBody"></tbody>
              </table>
            </div>
          </div>

          <!-- Transform -->
          <div class="mt-6 rounded-xl border border-slate-800">
            <div class="bg-slate-900/60 px-4 py-3 flex items-center justify-between">
              <div class="text-sm font-medium">Transform data</div>
              <div class="text-xs text-slate-400">These update the preview immediately</div>
            </div>
            <div class="p-4 grid md:grid-cols-2 gap-4">
              <div class="rounded-xl border border-slate-800 p-4 bg-slate-900/40">
                <div class="text-sm font-semibold mb-2">Clean text</div>
                <div class="grid grid-cols-2 gap-2">
                  <button class="t-btn px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" data-t="trim">Trim spaces</button>
                  <button class="t-btn px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" data-t="upper">UPPERCASE</button>
                  <button class="t-btn px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" data-t="lower">lowercase</button>
                  <button class="t-btn px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" data-t="title">Title Case</button>
                </div>
                <div class="mt-3">
                  <label class="text-xs text-slate-300">Apply to column</label>
                  <select id="transformColumn" class="w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100"></select>
                </div>
              </div>
              <div class="rounded-xl border border-slate-800 p-4 bg-slate-900/40">
                <div class="text-sm font-semibold mb-2">Type & rules</div>
                <div class="grid grid-cols-2 gap-2">
                  <button class="t-btn px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" data-t="number">Cast to number</button>
                  <button class="t-btn px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" data-t="dedupe">Deduplicate by column</button>
                </div>
                <div class="mt-3 grid grid-cols-2 gap-2">
                  <input id="findText" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm" placeholder="Find">
                  <input id="replaceText" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm" placeholder="Replace with">
                  <button id="findReplace" class="col-span-2 px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm">Find & replace</button>
                </div>
              </div>
            </div>
            <div class="px-4 pb-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="toggle">
                  <input id="liveTransform" type="checkbox" checked>
                  <div class="track bg-emerald-600/40"></div>
                  <div class="knob"></div>
                </div>
                <label for="liveTransform" class="text-sm">Live preview updates</label>
              </div>
              <div class="flex items-center gap-2">
                <button id="undoTransform" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">Undo</button>
                <button id="resetTransform" class="px-3 py-2 rounded-lg bg-rose-600/80 hover:bg-rose-600 text-sm">Reset</button>
              </div>
            </div>
          </div>

          <!-- Mapping -->
          <div class="mt-6 rounded-xl border border-slate-800 overflow-hidden">
            <div class="flex items-center justify-between bg-slate-900/60 px-4 py-3">
              <div class="text-sm font-medium">Map columns</div>
              <div class="flex items-center gap-2">
                <button id="autoMap" class="text-xs px-2 py-1 rounded bg-sky-600 hover:bg-sky-500">Auto-map</button>
                <button id="savePreset" class="text-xs px-2 py-1 rounded bg-emerald-600 hover:bg-emerald-500">Save preset</button>
                <select id="loadPreset" class="text-xs bg-slate-800 border border-slate-700 rounded px-2 py-1">
                  <option value="">Load preset…</option>
                </select>
              </div>
            </div>
            <div id="mappingArea" class="grid md:grid-cols-2 gap-4 p-4"></div>
          </div>

          <!-- Validation + Actions -->
          <div class="mt-6 grid md:grid-cols-3 gap-4">
            <div class="md:col-span-2 rounded-xl border border-slate-800">
              <div class="flex items-center justify-between bg-slate-900/60 px-4 py-3">
                <div class="text-sm font-medium">Validation</div>
                <div class="flex items-center gap-2">
                  <button id="runValidation" class="text-xs px-2 py-1 rounded bg-emerald-600 hover:bg-emerald-500">Run validation</button>
                  <button id="downloadIssues" class="text-xs px-2 py-1 rounded bg-slate-800 hover:bg-slate-700">Download issues</button>
                </div>
              </div>
              <div id="validationList" class="p-4 space-y-2 text-sm text-slate-300">
                No checks run yet.
              </div>
            </div>

            <div class="rounded-xl border border-slate-800 p-4">
              <div class="text-sm font-semibold mb-2">Schedule</div>
              <div class="grid grid-cols-3 gap-2">
                <button data-sched="once" class="schedBtn px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm" aria-pressed="true">Once</button>
                <button data-sched="daily" class="schedBtn px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">Daily</button>
                <button data-sched="weekly" class="schedBtn px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">Weekly</button>
              </div>
              <div class="mt-3 space-y-2">
                <label class="block text-xs text-slate-300">Start time</label>
                <input id="schedTime" type="datetime-local" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100" />
                <label class="block text-xs text-slate-300">Notify email (optional)</label>
                <input id="notifyEmail" type="email" placeholder="you@example.com" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100" />
              </div>
              <button id="runImport" class="mt-4 w-full px-4 py-2 rounded-lg bg-sky-600 hover:bg-sky-500 font-semibold">Run import</button>
              <button id="exportTransformed" class="mt-2 w-full px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">Download CSV</button>
            </div>
          </div>

          <!-- Progress -->
          <div id="progressWrap" class="hidden mt-6 rounded-xl border border-slate-800 overflow-hidden">
            <div class="bg-slate-900/60 px-4 py-3 text-sm font-medium">Import progress</div>
            <div class="p-4">
              <div class="w-full bg-slate-800 rounded-lg overflow-hidden">
                <div id="progressBar" class="h-3 bg-emerald-500 progress-stripes" style="width: 0%"></div>
              </div>
              <div id="progressText" class="text-sm text-slate-300 mt-2">Starting...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Schedules -->
      <div id="section-schedules" class="card bg-white/5 rounded-2xl p-6 border border-white/10 hidden">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-semibold">Schedules</h2>
            <p class="text-slate-300 text-sm">Planned imports</p>
          </div>
          <button id="addSchedule" class="px-3 py-2 rounded-lg bg-sky-600 hover:bg-sky-500">+ Add</button>
        </div>
        <div id="schedulesList" class="mt-4 divide-y divide-slate-800"></div>
      </div>

      <!-- History -->
      <div id="section-history" class="card bg-white/5 rounded-2xl p-6 border border-white/10 hidden">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">History</h2>
            <p class="text-slate-300 text-sm">Completed and past runs</p>
          </div>
          <div class="flex items-center gap-2">
            <select id="historyFilter" class="bg-slate-900 text-slate-100 text-sm rounded-lg px-2 py-1 border border-slate-800">
              <option value="all">All</option>
              <option value="success">Success</option>
              <option value="failed">Failed</option>
            </select>
            <button id="clearHistory" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">Clear</button>
          </div>
        </div>

        <div class="mt-4 overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-slate-300">
              <tr class="text-left">
                <th class="py-2 pr-4 font-medium">Time</th>
                <th class="py-2 pr-4 font-medium">Source</th>
                <th class="py-2 pr-4 font-medium">Rows</th>
                <th class="py-2 pr-4 font-medium">Status</th>
                <th class="py-2 pr-4 font-medium"></th>
              </tr>
            </thead>
            <tbody id="historyTable" class="divide-y divide-slate-800"></tbody>
          </table>
        </div>
      </div>

      <!-- Settings -->
      <div id="section-settings" class="card bg-white/5 rounded-2xl p-6 border border-white/10 hidden">
        <h2 class="text-lg font-semibold">Settings</h2>
        <div class="mt-4 grid md:grid-cols-2 gap-4">
          <div class="rounded-xl border border-slate-800 p-4">
            <div class="text-sm font-semibold">Default field mapping</div>
            <p class="text-slate-300 text-sm mt-1">These help auto-map columns</p>
            <div class="mt-3 space-y-2 text-sm">
              <div class="flex items-center justify-between gap-2">
                <label class="text-slate-300">Name fields</label>
                <input id="setNameAliases" type="text" class="w-2/3 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2" placeholder="name, full_name"/>
              </div>
              <div class="flex items-center justify-between gap-2">
                <label class="text-slate-300">Email fields</label>
                <input id="setEmailAliases" type="text" class="w-2/3 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2" placeholder="email, mail"/>
              </div>
              <button id="saveSettings" class="mt-2 px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm">Save</button>
            </div>
          </div>
          <div class="rounded-xl border border-slate-800 p-4">
            <div class="text-sm font-semibold">Export options</div>
            <p class="text-slate-300 text-sm mt-1">Download preview as CSV</p>
            <button id="downloadPreview" class="mt-3 px-3 py-2 rounded-lg bg-sky-600 hover:bg-sky-500 text-sm">Download CSV</button>
          </div>
        </div>
      </div>

      <!-- Connections -->
      <div id="section-connections" class="card bg-white/5 rounded-2xl p-6 border border-white/10 hidden">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-semibold">Connections</h2>
            <p class="text-slate-300 text-sm">Connect Google Sheets endpoints (placeholders)</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="testSheetsAPI" class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm">Test connection</button>
            <button id="saveConnections" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">Save</button>
          </div>
        </div>

        <div class="mt-4 grid md:grid-cols-2 gap-4">
          <div class="rounded-xl border border-slate-800 p-4 bg-slate-900/40">
            <div class="text-sm font-semibold">Google Sheets API</div>
            <p class="text-slate-300 text-sm mt-1">Add your public API details here. Replace placeholders later.</p>
            <div class="mt-3 space-y-2 text-sm">
              <label class="block text-xs text-slate-300">API Key</label>
              <input id="connApiKey" placeholder="YOUR_API_KEY_HERE" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2" />
              <label class="block text-xs text-slate-300 mt-3">Spreadsheet ID</label>
              <input id="connSpreadsheetId" placeholder="YOUR_SPREADSHEET_ID_HERE" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2" />
              <label class="block text-xs text-slate-300 mt-3">Default Range</label>
              <input id="connRange" placeholder="Sheet1!A1:D" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2" />
            </div>
          </div>

          <div class="rounded-xl border border-slate-800 p-4 bg-slate-900/40">
            <div class="text-sm font-semibold">List Spreadsheets (optional)</div>
            <p class="text-slate-300 text-sm mt-1">Paste a read-only listing endpoint or JSON (placeholders)</p>
            <div class="mt-3 space-y-2 text-sm">
              <textarea id="connListing" class="w-full h-40 bg-slate-800 border border-slate-700 rounded-lg p-3" placeholder='[{"id":"sheet_1","title":"My Sheet"}]'></textarea>
              <button id="previewListing" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500">Preview in Library</button>
            </div>
          </div>
        </div>

        <div class="mt-6 rounded-xl border border-slate-800 overflow-hidden">
          <div class="bg-slate-900/60 px-4 py-3 text-sm font-medium">Last test result</div>
          <pre id="connResult" class="p-4 text-xs text-slate-300 whitespace-pre-wrap">No test run yet.</pre>
        </div>
      </div>
    </section>
  </main>

  <!-- Modals -->
  <!-- Paste modal -->
  <div id="pasteModal" class="fixed inset-0 hidden z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative max-w-2xl mx-auto mt-20 bg-slate-900 border border-slate-800 rounded-2xl p-6">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-lg font-semibold">Paste data</div>
          <p class="text-slate-300 text-sm">Paste rows separated by commas or tabs</p>
        </div>
        <button class="text-slate-300 hover:text-white" data-close="#pasteModal">✕</button>
      </div>
      <textarea id="pasteBox" class="mt-4 w-full h-56 bg-slate-950 border border-slate-800 rounded-xl p-3 text-sm"></textarea>
      <div class="mt-4 flex items-center justify-end gap-2">
        <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" data-close="#pasteModal">Cancel</button>
        <button id="usePasted" class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500">Use data</button>
      </div>
    </div>
  </div>

  <!-- Sheets CSV modal -->
  <div id="sheetsCSVModal" class="fixed inset-0 hidden z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative max-w-2xl mx-auto mt-20 bg-slate-900 border border-slate-800 rounded-2xl p-6">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-lg font-semibold">Import from Google Sheets (CSV)</div>
          <p class="text-slate-300 text-sm">From Google Sheets: File → Share → Publish to web → CSV</p>
        </div>
        <button class="text-slate-300 hover:text-white" data-close="#sheetsCSVModal">✕</button>
      </div>
      <div class="mt-4 space-y-3">
        <input id="sheetsUrl" type="url" placeholder="https://docs.google.com/spreadsheets/d/e/.../pub?output=csv" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-sm" />
        <div class="text-xs text-slate-400">No key needed. Works with publicly published CSV links.</div>
      </div>
      <div class="mt-4 flex items-center justify-end gap-2">
        <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" data-close="#sheetsCSVModal">Cancel</button>
        <button id="useSheetsCSV" class="px-3 py-2 rounded-lg bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold">Load</button>
      </div>
    </div>
  </div>

  <!-- Sheets API modal (placeholders) -->
  <div id="sheetsAPIModal" class="fixed inset-0 hidden z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative max-w-2xl mx-auto mt-16 bg-slate-900 border border-slate-800 rounded-2xl p-6">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-lg font-semibold">Google Sheets API</div>
          <p class="text-slate-300 text-sm">Add your details below. These are placeholders you will replace.</p>
        </div>
        <button class="text-slate-300 hover:text-white" data-close="#sheetsAPIModal">✕</button>
      </div>
      <div class="mt-4 grid gap-3">
        <input id="apiKey" placeholder="YOUR_API_KEY_HERE" class="bg-slate-950 border border-slate-800 rounded-xl p-3 text-sm" />
        <input id="spreadsheetId" placeholder="YOUR_SPREADSHEET_ID_HERE" class="bg-slate-950 border border-slate-800 rounded-xl p-3 text-sm" />
        <input id="sheetRange" placeholder="Sheet1!A1:D (or A1:Z)" class="bg-slate-950 border border-slate-800 rounded-xl p-3 text-sm" />
        <div class="text-xs text-slate-400">
          Note: This front-end fetch uses your key in the browser. For private sheets or secure keys, use a backend proxy.
        </div>
      </div>
      <div class="mt-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <input id="rememberAPI" type="checkbox" class="rounded border-slate-700 bg-slate-900">
          <label for="rememberAPI" class="text-sm text-slate-300">Remember these (local only)</label>
        </div>
        <div class="flex items-center gap-2">
          <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" data-close="#sheetsAPIModal">Cancel</button>
          <button id="useSheetsAPI" class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500">Load via API</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden">
    <div class="rounded-xl bg-slate-900 border border-slate-800 px-4 py-3 text-sm shadow-lg"></div>
  </div>

  <script>
    // App state
    const state = {
      activeSection: 'dashboard',
      rawText: '',
      delimiter: ',',
      headers: [],
      rows: [],
      originalRows: [], // for undo/reset
      mappings: {}, // sourceHeader -> targetField
      targetFields: [
        {key:'full_name', label:'Full Name', required:true},
        {key:'email', label:'Email', required:true},
        {key:'age', label:'Age', required:false},
        {key:'city', label:'City', required:false}
      ],
      schedules: [],
      history: [],
      stats: { totalImports: 0, totalRows: 0, successes: 0, failures: 0 },
      settings: {
        nameAliases: ['name','full_name','fullname'],
        emailAliases: ['email','mail','e-mail']
      },
      presets: {}, // name -> mappings
      lastIssues: [], // for download
    };

    // Helpers
    const $ = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');
    const toast = (msg) => { const t = $('#toast'); t.firstElementChild.textContent = msg; show(t); setTimeout(()=>hide(t), 2200); };

    function setActive(section) {
      state.activeSection = section;
      ['dashboard','library','imports','schedules','history','settings','connections'].forEach(id=>{
        const el = $('#section-'+id);
        if(!el) return;
        if(id===section) show(el); else hide(el);
      });
      $$('#sidebarMenu button').forEach(b=>{
        b.setAttribute('aria-selected', b.dataset.section===section ? 'true' : 'false');
      });
      if (section === 'library') renderLibrary();
    }

    // CSV parse (quoted)
    function parseCSV(text, delimiter) {
      const delim = delimiter === 'tab' ? '\t' : delimiter;
      const rows = [];
      let row = [], value = '', inQuotes = false;
      const pushValue = () => { row.push(value); value=''; };

      for (let i=0; i<text.length; i++) {
        const c = text[i], n = text[i+1];
        if (c === '"') {
          if (inQuotes && n === '"') { value += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (c === '\r') {
          // ignore
        } else if (!inQuotes && c === delim) {
          pushValue();
        } else if (!inQuotes && (c === '\n')) {
          pushValue(); rows.push(row); row=[];
        } else {
          value += c;
        }
      }
      if (value.length || row.length) { pushValue(); rows.push(row); }
      return rows.filter(r => r.some(cell => String(cell).trim() !== ''));
    }

    function applyParsing() {
      const rows = parseCSV(state.rawText, state.delimiter);
      if (!rows.length) { state.headers=[]; state.rows=[]; state.originalRows=[]; renderPreview(); buildMappingUI(); return; }
      state.headers = rows[0].map(h=>String(h).trim());
      state.rows = rows.slice(1);
      state.originalRows = JSON.parse(JSON.stringify(state.rows));
      renderPreview();
      buildMappingUI();
      fillTransformColumnList();
    }

    // Preview
    function computeFilteredRows() {
      let out = state.rows;
      const q = $('#quickFilter').value.trim().toLowerCase();
      if (q) out = out.filter(r => r.some(c => String(c ?? '').toLowerCase().includes(q)));
      const limitVal = $('#rowLimit').value;
      if (limitVal !== 'All') out = out.slice(0, Number(limitVal));
      return out;
    }

    function renderPreview() {
      const head = $('#previewHead'); const body = $('#previewBody');
      head.innerHTML=''; body.innerHTML='';
      if (!state.headers.length) return;
      state.headers.forEach(h=>{
        const th = document.createElement('th');
        th.className="text-left py-2 px-3 text-slate-300";
        th.textContent = h;
        head.appendChild(th);
      });
      const sample = computeFilteredRows();
      sample.forEach(r=>{
        const tr = document.createElement('tr');
        tr.className = "border-t border-slate-800";
        state.headers.forEach((_,i)=>{
          const td = document.createElement('td');
          td.className = "py-2 px-3";
          td.textContent = r[i] ?? '';
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    }

    // Transform
    function fillTransformColumnList() {
      const sel = $('#transformColumn'); if (!sel) return;
      sel.innerHTML = state.headers.map(h=>`<option value="${h}">${h}</option>`).join('');
    }

    function applyTransform(type) {
      const colName = $('#transformColumn').value;
      const idx = state.headers.indexOf(colName);
      if (idx === -1) { toast('Choose a column first'); return; }
      // snapshot for undo
      if ($('#liveTransform').checked) {
        state._undo = JSON.parse(JSON.stringify(state.rows));
      }
      const toTitle = (s) => String(s).toLowerCase().replace(/\b\w/g, m=>m.toUpperCase());
      const castNum = (s) => {
        const n = Number(String(s).replace(/[^0-9.\-]/g,''));
        return Number.isFinite(n) ? n : '';
      };
      if (type === 'trim') state.rows.forEach(r=> r[idx] = String(r[idx] ?? '').trim());
      if (type === 'upper') state.rows.forEach(r=> r[idx] = String(r[idx] ?? '').toUpperCase());
      if (type === 'lower') state.rows.forEach(r=> r[idx] = String(r[idx] ?? '').toLowerCase());
      if (type === 'title') state.rows.forEach(r=> r[idx] = toTitle(r[idx] ?? ''));
      if (type === 'number') state.rows.forEach(r=> r[idx] = castNum(r[idx] ?? ''));
      if (type === 'dedupe') {
        const seen = new Set();
        state.rows = state.rows.filter(r=>{
          const key = String(r[idx] ?? '').toLowerCase().trim();
          if (!key) return true;
          if (seen.has(key)) return false;
          seen.add(key); return true;
        });
      }
      if ($('#liveTransform').checked) renderPreview();
    }

    // Mapping
    function buildMappingUI() {
      const area = $('#mappingArea'); area.innerHTML='';
      if (!state.headers.length) { area.innerHTML = '<div class="text-sm text-slate-300">No columns to map.</div>'; return; }
      state.targetFields.forEach(field=>{
        const wrap = document.createElement('div');
        wrap.className = "rounded-xl border border-slate-800 p-4 bg-slate-900/40";
        wrap.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">${field.label}</div>
            ${field.required ? '<span class="text-xs text-rose-300">Required</span>': '<span class="text-xs text-slate-400">Optional</span>'}
          </div>
          <div class="mt-2">
            <select data-target="${field.key}" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100">
              <option value="">— Not mapped —</option>
              ${state.headers.map(h=>`<option value="${h}">${h}</option>`).join('')}
            </select>
          </div>
        `;
        area.appendChild(wrap);
      });

      // Prefill from state
      $$('#mappingArea select').forEach(sel=>{
        const key = sel.dataset.target;
        const prev = Object.entries(state.mappings).find(([src, tgt])=>tgt===key);
        if (prev) sel.value = prev[0];
        sel.onchange = (e)=>{
          Object.keys(state.mappings).forEach(src=>{
            if (state.mappings[src] === key) delete state.mappings[src];
          });
          if (e.target.value) state.mappings[e.target.value] = key;
        };
      });
    }

    function autoMap() {
      const aliases = {
        full_name: ['full name','fullname','name', ...state.settings.nameAliases],
        email: ['email','mail','e-mail','e mail', ...state.settings.emailAliases],
        age: ['age','years'],
        city: ['city','town','location']
      };
      Object.keys(state.mappings).forEach(k=>delete state.mappings[k]);
      state.headers.forEach(h=>{
        const clean = h.toLowerCase().replace(/[_\-]/g,' ').trim();
        for (const field of state.targetFields) {
          if (aliases[field.key]?.some(a => clean === a || clean.includes(a))) {
            if (!Object.values(state.mappings).includes(field.key)) {
              state.mappings[h] = field.key;
              break;
            }
          }
        }
      });
      buildMappingUI();
      toast('Auto-mapped based on names');
    }

    // Presets
    function refreshPresetList() {
      const sel = $('#loadPreset');
      const keys = Object.keys(state.presets);
      sel.innerHTML = '<option value="">Load preset…</option>' + keys.map(k=>`<option>${k}</option>`).join('');
    }
    function savePreset() {
      const name = prompt('Preset name?');
      if (!name) return;
      state.presets[name] = {...state.mappings};
      localStorage.setItem('import_presets', JSON.stringify(state.presets));
      refreshPresetList();
      toast('Preset saved');
    }
    function loadPreset(name) {
      const map = state.presets[name];
      if (!map) return;
      state.mappings = {...map};
      buildMappingUI();
      toast('Preset applied');
    }

    // Validation
    function validateData() {
      const out = [];
      // Required fields mapped?
      state.targetFields.filter(f=>f.required).forEach(f=>{
        const mapped = Object.values(state.mappings).includes(f.key);
        out.push({type: mapped ? 'ok' : 'error', msg: mapped ? `${f.label} mapped` : `${f.label} not mapped`});
      });
      // Email format simple check
      const emailSrc = Object.keys(state.mappings).find(s => state.mappings[s]==='email');
      if (emailSrc) {
        const idx = state.headers.indexOf(emailSrc);
        const invalidRows = [];
        state.rows.forEach((r,i)=>{
          const v = r[idx];
          if (v && !/.+@.+\..+/.test(String(v))) invalidRows.push(i+2); // +2 for header offset
        });
        out.push({type: invalidRows.length ? 'warn' : 'ok', msg: invalidRows.length ? `${invalidRows.length} possible invalid emails (rows ${invalidRows.slice(0,5).join(', ')}${invalidRows.length>5?'…':''})` : 'Emails look okay'});
      }
      // Duplicates by email
      if (emailSrc) {
        const idx = state.headers.indexOf(emailSrc);
        const seen = new Set(); let dups=0;
        state.rows.forEach(r=>{
          const key = String(r[idx] ?? '').toLowerCase().trim();
          if (!key) return;
          if (seen.has(key)) dups++; else seen.add(key);
        });
        out.push({type: dups ? 'warn':'ok', msg: dups ? `${dups} duplicate emails` : 'No duplicates found'});
      }
      // Row count
      out.push({type: state.rows.length ? 'ok':'error', msg: `${state.rows.length} rows detected`});

      renderValidation(out);
      state.lastIssues = out;
      return out;
    }

    function renderValidation(list) {
      const area = $('#validationList');
      if (!list.length) { area.textContent='No checks run yet.'; return; }
      area.innerHTML = '';
      list.forEach(i=>{
        const b = document.createElement('div');
        b.className = `flex items-center gap-2 px-3 py-2 rounded-lg border ${i.type==='ok'?'border-emerald-700 bg-emerald-900/30': i.type==='warn' ? 'border-amber-700 bg-amber-900/20' : 'border-rose-700 bg-rose-900/30'}`;
        const dot = i.type==='ok' ? 'bg-emerald-400' : (i.type==='warn' ? 'bg-amber-400':'bg-rose-400');
        b.innerHTML = `<span class="w-2 h-2 rounded-full ${dot}"></span><span>${i.msg}</span>`;
        area.appendChild(b);
      });
    }

    function updateStats(success, rows) {
      state.stats.totalImports += 1;
      state.stats.totalRows += rows;
      if (success) state.stats.successes += 1; else state.stats.failures += 1;
      $('#stat-total-imports').textContent = state.stats.totalImports;
      $('#stat-total-rows').textContent = state.stats.totalRows;
      const total = state.stats.successes + state.stats.failures;
      $('#stat-success-rate').textContent = total ? Math.round((state.stats.successes/total)*100)+'%' : '—';
    }

    function addHistory(entry) {
      state.history.unshift(entry);
      renderHistory();
      renderDashboardRecent();
    }

    function renderHistory() {
      const tbody = $('#historyTable'); tbody.innerHTML='';
      const filter = $('#historyFilter').value;
      const items = state.history.filter(h => filter==='all' ? true : h.status === filter);
      items.forEach(h=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 pr-4 text-slate-300">${new Date(h.time).toLocaleString()}</td>
          <td class="py-2 pr-4">${h.source}</td>
          <td class="py-2 pr-4">${h.rows}</td>
          <td class="py-2 pr-4">
            <span class="text-xs px-2 py-1 rounded-full ${h.status==='success'?'bg-emerald-600/20 text-emerald-300 border border-emerald-700/40':'bg-rose-600/20 text-rose-300 border border-rose-700/40'}">${h.status}</span>
          </td>
          <td class="py-2 pr-4">
            <button class="text-sky-400 hover:underline text-sm" data-view="${h.id}">Details</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      $$('button[data-view]').forEach(b=>{
        b.onclick = () => {
          const i = state.history.find(x=> String(x.id)===b.dataset.view);
          alert(`Import #${i.id}\nSource: ${i.source}\nRows: ${i.rows}\nStatus: ${i.status}`);
        };
      });
    }

    function renderDashboardRecent() {
      const wrap = $('#dashboardRecent'); wrap.innerHTML='';
      const items = state.history.slice(0,5);
      if (!items.length) { wrap.innerHTML = '<div class="text-sm text-slate-300">No activity yet.</div>'; return; }
      items.forEach(h=>{
        const row = document.createElement('div');
        row.className = "flex items-center justify-between px-3 py-2 rounded-lg bg-slate-900/40 border border-slate-800";
        row.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="w-2 h-2 rounded-full ${h.status==='success'?'bg-emerald-400':'bg-rose-400'}"></span>
            <div>
              <div class="text-sm">${h.source} • ${h.rows} rows</div>
              <div class="text-xs text-slate-400">${new Date(h.time).toLocaleString()}</div>
            </div>
          </div>
          <div class="text-xs px-2 py-1 rounded bg-white/10 border border-white/10">${h.status}</div>
        `;
        wrap.appendChild(row);
      });
    }

    function renderSchedules() {
      const list = $('#schedulesList'); list.innerHTML='';
      if (!state.schedules.length) {
        list.innerHTML = '<div class="text-sm text-slate-300 py-6 text-center">No schedules yet.</div>'; return;
      }
      state.schedules.forEach((s, idx)=>{
        const row = document.createElement('div');
        row.className = "py-3 flex items-center justify-between";
        row.innerHTML = `
          <div>
            <div class="font-medium text-sm">${s.name || 'Unnamed schedule'}</div>
            <div class="text-xs text-slate-400">${s.type.toUpperCase()} • starts ${new Date(s.when).toLocaleString()}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-xs" data-run-sched="${idx}">Run now</button>
            <button class="px-2 py-1 rounded bg-rose-700/40 hover:bg-rose-700/60 text-rose-200 text-xs" data-del-sched="${idx}">Delete</button>
          </div>
        `;
        list.appendChild(row);
      });
      $$('button[data-del-sched]').forEach(b=>{
        b.onclick = ()=>{ state.schedules.splice(+b.dataset.delSched,1); renderSchedules(); toast('Schedule removed'); };
      });
      $$( 'button[data-run-sched]').forEach(b=>{
        b.onclick = ()=>{ toast('Schedule executed (demo)'); };
      });
    }

    // Library
    const libraryState = { items: [] };

    function spreadsheetIconSVG() {
      return `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="3" y="2" width="18" height="20" rx="3" fill="rgba(16,185,129,0.2)" stroke="rgba(16,185,129,0.6)" />
        <path d="M7 7H17M7 11H17M7 15H12" stroke="#34d399" stroke-width="1.5" stroke-linecap="round"/>
      </svg>`;
    }

    function renderLibrary() {
      const grid = $('#libraryGrid');
      const empty = $('#libraryEmpty');
      const q = ($('#librarySearch')?.value || '').toLowerCase().trim();
      let items = libraryState.items;
      if (q) items = items.filter(it => it.title.toLowerCase().includes(q));
      grid.innerHTML = '';
      if (!items.length) { show(empty); return; } else hide(empty);
      items.forEach((it, idx)=>{
        const card = document.createElement('div');
        card.className = 'rounded-xl border border-slate-800 bg-slate-900/40 p-4 card hover:border-slate-700';
        card.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="shrink-0">${spreadsheetIconSVG()}</div>
            <div class="min-w-0">
              <div class="font-medium truncate">${it.title}</div>
              <div class="text-xs text-slate-400 truncate">${it.subtitle || 'Spreadsheet'}</div>
              <div class="mt-3 flex items-center gap-2">
                <button class="px-2 py-1 rounded bg-sky-600 hover:bg-sky-500 text-xs text-white" data-open="${idx}">Open</button>
                <button class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-xs" data-import="${idx}">Import</button>
              </div>
            </div>
          </div>`;
        grid.appendChild(card);
      });
      $$('[data-open]').forEach(b=> b.onclick = ()=> toast('Open (placeholder)'));
      $$('[data-import]').forEach(b=> b.onclick = (e)=> {
        const idx = +e.currentTarget.dataset.import;
        const item = items[idx];
        // Placeholder: if item has csvUrl, load via fetch; if api info, build API URL
        if (item?.csvUrl) {
          fetch(item.csvUrl).then(r=>r.text()).then(txt=>{
            state.rawText = txt; applyParsing(); preparePipeline(item.title);
          }).catch(()=>toast('Failed to load item'));
        } else if (item?.api) {
          const { key, spreadsheetId, range } = item.api; // placeholders
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range||'Sheet1!A1:D')}?key=${key}`;
          fetch(url).then(r=>r.json()).then(json=>{
            if (!json.values) throw new Error();
            const toCSV = (arr) => arr.map(r => r.map(v=>{
              const s = String(v ?? '');
              return /[,"\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
            }).join(',')).join('\n');
            state.rawText = toCSV(json.values); applyParsing(); preparePipeline(item.title);
          }).catch(()=>toast('Failed to load item via API'));
        } else {
          toast('No source defined for this item');
        }
      });
    }

    // Prepare pipeline after data load
    function preparePipeline(sourceLabel='Imported data') {
      show($('#pipeline'));
      renderPreview();
      buildMappingUI();
      fillTransformColumnList();
      setActive('imports');
      toast(`${sourceLabel} ready`);
    }

    // File handlers
    $('#csvFile').addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        state.rawText = reader.result;
        applyParsing();
        preparePipeline('CSV file');
      };
      reader.readAsText(file);
    });

    // Sample CSV
    $('#csvSample').onclick = ()=>{
      state.rawText = 'Full Name,Email,Age,City\nAlex Rivera,alex@example.com,29,Austin\nJamie O\'Neil,jamie@example.com,31,Denver\nPat Doe,pat.doe@example,27,Seattle';
      applyParsing(); preparePipeline('Sample CSV');
    };

    // Paste modal
    $('#openPaste').onclick = ()=>{ show($('#pasteModal')); $('#pasteBox').value=''; };
    $('#usePasted').onclick = ()=>{
      const text = $('#pasteBox').value.trim();
      if (!text) return toast('Nothing pasted');
      state.rawText = text;
      hide($('#pasteModal')); applyParsing(); preparePipeline('Pasted data');
    };
    $$('[data-close="#pasteModal"]').forEach(btn=>btn.onclick = ()=> hide($('#pasteModal')));

    // Sheets CSV
    $('#openSheetsCSV').onclick = ()=> show($('#sheetsCSVModal'));
    $('#useSheetsCSV').onclick = async ()=>{
      const url = $('#sheetsUrl').value.trim();
      if (!url) { toast('Please paste a CSV link'); return; }
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to fetch');
        const text = await res.text();
        state.rawText = text;
        hide($('#sheetsCSVModal'));
        applyParsing(); preparePipeline('Google Sheets (CSV)');
      } catch (e) {
        toast('Could not load the link');
      }
    };
    $$('[data-close="#sheetsCSVModal"]').forEach(btn=>btn.onclick = ()=> hide($('#sheetsCSVModal')));

    // Sheets API (placeholders)
    $('#openSheetsAPI').onclick = ()=>{
      show($('#sheetsAPIModal'));
      // load remembered
      const saved = JSON.parse(localStorage.getItem('gs_api_cfg') || 'null');
      if (saved) {
        $('#apiKey').value = saved.apiKey || '';
        $('#spreadsheetId').value = saved.spreadsheetId || '';
        $('#sheetRange').value = saved.sheetRange || '';
        $('#rememberAPI').checked = true;
      }
    };
    $('#useSheetsAPI').onclick = async ()=>{
      const apiKey = $('#apiKey').value.trim() || 'YOUR_API_KEY_HERE';
      const spreadsheetId = $('#spreadsheetId').value.trim() || 'YOUR_SPREADSHEET_ID_HERE';
      const range = encodeURIComponent($('#sheetRange').value.trim() || 'Sheet1!A1:D');
      // Remember locally if asked
      if ($('#rememberAPI').checked) {
        localStorage.setItem('gs_api_cfg', JSON.stringify({apiKey, spreadsheetId, sheetRange: decodeURIComponent(range)}));
      }
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Request failed');
        const json = await res.json();
        if (!json.values || !json.values.length) throw new Error('No data');
        // Convert array of arrays into CSV text
        const toCSV = (arr) => arr.map(r => r.map(v=>{
          const s = String(v ?? '');
          return /[,"\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
        }).join(',')).join('\n');
        state.rawText = toCSV(json.values);
        hide($('#sheetsAPIModal'));
        applyParsing(); preparePipeline('Google Sheets API');
      } catch (e) {
        toast('API load failed. Check placeholders.');
      }
    };
    $$('[data-close="#sheetsAPIModal"]').forEach(btn=>btn.onclick = ()=> hide($('#sheetsAPIModal')));

    // Delimiter & preview controls
    $('#delimiter').onchange = (e)=>{ state.delimiter = e.target.value; if (state.rawText) { applyParsing(); } };
    $('#quickFilter').oninput = renderPreview;
    $('#rowLimit').onchange = renderPreview;

    // Transform buttons
    $$('.t-btn').forEach(b=> b.onclick = ()=> applyTransform(b.dataset.t));
    $('#findReplace').onclick = ()=>{
      const colName = $('#transformColumn').value;
      const idx = state.headers.indexOf(colName);
      if (idx === -1) { toast('Choose a column first'); return; }
      const find = $('#findText').value; const rep = $('#replaceText').value;
      if (!find) { toast('Add text to find'); return; }
      state._undo = JSON.parse(JSON.stringify(state.rows));
      const re = new RegExp(find, 'gi');
      state.rows.forEach(r=> r[idx] = String(r[idx] ?? '').replace(re, rep));
      renderPreview();
    };
    $('#undoTransform').onclick = ()=>{
      if (!state._undo) { toast('Nothing to undo'); return; }
      state.rows = state._undo; state._undo = null; renderPreview();
    };
    $('#resetTransform').onclick = ()=>{
      state.rows = JSON.parse(JSON.stringify(state.originalRows));
      state._undo = null; renderPreview();
    };

    // Auto-map & presets
    $('#autoMap').onclick = autoMap;
    $('#savePreset').onclick = savePreset;
    $('#loadPreset').onchange = (e)=> { if (e.target.value) loadPreset(e.target.value); };

    // Validation
    $('#runValidation').onclick = ()=> {
      const res = validateData();
      const hasError = res.some(r=>r.type==='error');
      toast(hasError ? 'Found issues' : 'Looks good!');
    };
    $('#downloadIssues').onclick = ()=>{
      if (!state.lastIssues.length) { toast('No issues to download'); return; }
      const text = state.lastIssues.map(i=>`${i.type.toUpperCase()}: ${i.msg}`).join('\n');
      const blob = new Blob([text], {type:'text/plain;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'validation_issues.txt';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      toast('Issues downloaded');
    };

    // Schedule buttons
    let currentScheduleType = 'once';
    $$('.schedBtn').forEach(b=>{
      b.onclick = ()=>{
        currentScheduleType = b.dataset.sched;
        $$('.schedBtn').forEach(x=>x.setAttribute('aria-pressed', 'false'));
        b.setAttribute('aria-pressed', 'true');
        toast(`Schedule set: ${currentScheduleType}`);
      };
    });

    // Export transformed CSV
    function downloadCSVFromRows(filename, headers, rows) {
      const all = [headers, ...rows];
      const text = all.map(r => r.map(v=>{
        const s = String(v ?? '');
        return /[,"\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(',')).join('\n');
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    $('#exportTransformed').onclick = ()=>{
      if (!state.headers.length) return toast('Nothing to download');
      downloadCSVFromRows('transformed.csv', state.headers, state.rows);
      toast('Download started');
    };
    $('#downloadPreview').onclick = ()=>{
      if (!state.headers.length) return toast('Nothing to download');
      downloadCSVFromRows('preview.csv', state.headers, state.rows);
      toast('Download started');
    };

    // Run import (simulated)
    $('#runImport').onclick = ()=>{
      const checks = validateData();
      const hasError = checks.some(r=>r.type==='error');
      if (hasError) { toast('Please fix errors before running'); return; }
      show($('#progressWrap'));
      $('#progressBar').style.width = '0%';
      $('#progressText').textContent = 'Starting...';

      // Save schedule if future time
      const when = $('#schedTime').value;
      if (when) {
        state.schedules.push({ name: 'Import schedule', type: currentScheduleType, when, email: $('#notifyEmail').value || '' });
        renderSchedules();
      }

      let p=0;
      const total = state.rows.length || 50;
      const timer = setInterval(()=>{
        p += Math.random()*20;
        if (p>=100) p=100;
        $('#progressBar').style.width = p+'%';
        $('#progressText').textContent = `Processing rows... ${Math.min(Math.round(p/100*total), total)} / ${total}`;
        if (p>=100) {
          clearInterval(timer);
          setTimeout(()=>{
            hide($('#progressWrap'));
            const success = Math.random() > 0.1;
            const rows = state.rows.length;
            updateStats(success, rows);
            const entry = {
              id: Date.now(),
              time: Date.now(),
              source: 'CSV / Sheets',
              rows: rows,
              status: success ? 'success' : 'failed'
            };
            addHistory(entry);
            setActive('history');
            toast(success ? 'Import complete' : 'Import finished with errors');
          }, 400);
        }
      }, 380);
    };

    // Schedules
    $('#addSchedule').onclick = ()=>{
      state.schedules.push({
        name: 'New schedule',
        type: 'daily',
        when: new Date(Date.now()+3600e3).toISOString()
      });
      renderSchedules();
      toast('Schedule added');
    };

    // History
    $('#historyFilter').onchange = renderHistory;
    $('#clearHistory').onclick = ()=>{ state.history = []; renderHistory(); renderDashboardRecent(); toast('History cleared'); };

    // Settings
    $('#saveSettings').onclick = ()=>{
      const names = $('#setNameAliases').value.trim();
      const emails = $('#setEmailAliases').value.trim();
      if (names) state.settings.nameAliases = names.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
      if (emails) state.settings.emailAliases = emails.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
      toast('Settings saved');
      localStorage.setItem('import_settings', JSON.stringify(state.settings));
    };

    // Dashboard quick button
    $('#startImportFromDashboard').onclick = ()=> setActive('imports');

    // Sidebar nav
    $$('#sidebarMenu button').forEach(b=> b.onclick = ()=> setActive(b.dataset.section));

    // Library interactions
    $('#refreshLibrary').onclick = ()=>{
      // Sample items; replace with Google Drive/Sheets list if needed later
      libraryState.items = [
        { id: 'sheet_1', title: 'Sales Q1', subtitle: '2025 • Team' },
        { id: 'sheet_2', title: 'Customer Contacts', subtitle: 'CRM' },
        { id: 'sheet_3', title: 'Inventory Snapshot', subtitle: 'Warehouse' },
        { id: 'sheet_4', title: 'Marketing Leads', subtitle: 'Campaign A' },
        { id: 'sheet_5', title: 'Budget 2025', subtitle: 'Finance' },
        { id: 'sheet_6', title: 'Product Catalogue', subtitle: 'Public' }
      ];
      renderLibrary();
      if (!libraryState.items.length) show($('#libraryEmpty')); else hide($('#libraryEmpty'));
      toast('Library refreshed');
    };
    $('#librarySearch').oninput = ()=> renderLibrary();

    // Publish info
    $('#publishInfo').onclick = (e)=> {
      e.preventDefault();
      alert('About connections:\n\n1) Google Sheets CSV link works without keys (Publish to web → CSV).\n2) Google Sheets API works with your own API key and public or permitted sheets.\n3) Private sheets or secure keys should use a backend proxy.\n\nIn Canva, click Use in a design → Publish website to share.');
    };

    // Connections actions
    $('#testSheetsAPI').onclick = async ()=>{
      const key = $('#connApiKey').value.trim() || 'YOUR_API_KEY_HERE';
      const sid = $('#connSpreadsheetId').value.trim() || 'YOUR_SPREADSHEET_ID_HERE';
      const rng = encodeURIComponent($('#connRange').value.trim() || 'Sheet1!A1:D');
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sid}/values/${rng}?key=${key}`;
      $('#connResult').textContent = 'Testing...';
      try {
        const res = await fetch(url);
        const text = await res.text();
        $('#connResult').textContent = text.slice(0, 2000) + (text.length>2000?'\n...':'' );
      } catch(e) {
        $('#connResult').textContent = 'Failed to reach API. Check placeholders.';
      }
    };
    $('#saveConnections').onclick = ()=>{
      const cfg = {
        apiKey: $('#connApiKey').value.trim() || 'YOUR_API_KEY_HERE',
        spreadsheetId: $('#connSpreadsheetId').value.trim() || 'YOUR_SPREADSHEET_ID_HERE',
        range: $('#connRange').value.trim() || 'Sheet1!A1:D'
      };
      localStorage.setItem('gs_conn_cfg', JSON.stringify(cfg));
      toast('Connections saved locally');
    };
    $('#previewListing').onclick = ()=>{
      try {
        const data = JSON.parse($('#connListing').value || '[]');
        libraryState.items = data;
        setActive('library');
        renderLibrary();
        toast('Library updated from listing');
      } catch(e) { toast('Invalid JSON'); }
    };

    // Load persisted
    (function init(){
      try {
        const presets = JSON.parse(localStorage.getItem('import_presets') || '{}'); state.presets = presets; refreshPresetList();
        const settings = JSON.parse(localStorage.getItem('import_settings') || 'null'); if (settings) state.settings = settings;
        const conn = JSON.parse(localStorage.getItem('gs_conn_cfg') || 'null');
        if (conn) {
          $('#connApiKey').value = conn.apiKey || '';
          $('#connSpreadsheetId').value = conn.spreadsheetId || '';
          $('#connRange').value = conn.range || '';
        }
      } catch(e){}
      setActive('dashboard');
      renderHistory();
      renderSchedules();
    })();
  </script>
</html>
